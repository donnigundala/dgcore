# `cache` Package

## Overview

The `cache` package provides a unified and high-performance interface for interacting with various caching backends like Redis and Memcache. It is designed for robustness and ease of use, integrating seamlessly with the framework's configuration and context-aware logging systems.

## Core Concepts

### 1. The `Manager`

The `Manager` is the central component that handles the lifecycle of all named cache connections.

-   **Centralized Connections**: Manage multiple cache connections (e.g., one for application data, another for sessions) from a single point.
-   **Graceful Shutdown**: The `Close()` method ensures all underlying cache connections are terminated cleanly.
-   **Configuration-Driven**: The manager is initialized directly from your application's configuration.

### 2. The `Provider` Interface

All cache drivers (Redis, Memcache, etc.) implement a consistent `Provider` interface. This allows you to switch caching backends with only a configuration change, without altering your application code.

```go
type Provider interface {
    Ping(ctx context.Context) error
    Set(ctx context.Context, key string, value any, ttl ...time.Duration) error
    Get(ctx context.Context, key string, dest any) error
    Delete(ctx context.Context, key string) error
    // ... and more
}
```

### 3. Context-Aware Logging

The `cache` package is fully integrated with the framework's context-aware logging pattern provided by the `dcontext` package.

-   **Automatic Tracing**: When you perform a cache operation (e.g., `Get`, `Set`), the driver automatically retrieves the logger from the context using `dcontext.LoggerFromContext(ctx)`.
-   **Request-Scoped Logs**: If a `request_id` is present in the context (injected by the `server` middleware), all log entries generated by the cache package for that operation will automatically include that `request_id`, enabling effortless end-to-end tracing.

## Full Usage Example

The following example demonstrates how to configure and use the cache manager and its providers.

### 1. `config/app.yaml`

First, define your cache connections in your application's configuration file. You can define multiple named connections.

```yaml
# The top-level key 'caches' can be whatever you prefer.
caches:
  # The 'default' cache connection using Redis
  default:
    driver: "redis"
    namespace: "my_app"
    separator: ":"
    redis:
      host: "127.0.0.1"
      port: "6379"
      password: ${REDIS_PASSWORD} # Example of using an env var
      db: 0
      ttl: "2h"

  # A second cache connection using Memcache
  session_cache:
    driver: "memcache"
    namespace: "sessions"
    memcache:
      servers:
        - "127.0.0.1:11211"
        - "127.0.0.1:11212"
      ttl: "30m"
```

### 2. `main.go`

In your application's entrypoint, initialize the manager and retrieve the providers you need.

```go
package main

import (
    "context"
    "log/slog"
    "os"

    "github.com/donnigundala/dgcore/cache"
    "github.com/donnigundala/dgcore/config"
    "github.com/donnigundala/dgcore/dcontext"
)

func main() {
    // 1. Bootstrap logger and load configuration
    logger := slog.New(slog.NewTextHandler(os.Stdout, nil))
    slog.SetDefault(logger)

    if err := config.Load("config/app.yaml"); err != nil {
        logger.Error("failed to load configuration", "error", err)
        os.Exit(1)
    }

    // 2. Inject the cache configurations into a map
    var cacheConfigs map[string]*cache.Config
    if err := config.Inject("caches", &cacheConfigs); err != nil {
        logger.Error("failed to inject cache configuration", "error", err)
        os.Exit(1)
    }

    // 3. Initialize the Cache Manager
    cacheManager, err := cache.NewManager(cacheConfigs, cache.WithLogger(logger))
    if err != nil {
        logger.Error("failed to initialize cache manager", "error", err)
        os.Exit(1)
    }
    defer cacheManager.Close()

    // 4. Get a specific cache provider
    redisCache, err := cacheManager.Get("default")
    if err != nil {
        logger.Error("failed to get default cache provider", "error", err)
        os.Exit(1)
    }

    // 5. Use the cache provider
    // Create a sample context, similar to what the server middleware would do.
    ctx := context.Background()
    ctx = dcontext.WithLogger(ctx, logger.With("request_id", "abc-123"))

    // Set a value
    err = redisCache.Set(ctx, "my_key", "my_value")
    if err != nil {
        logger.Error("failed to set value in cache", "error", err)
    }

    // Get a value
    var result string
    err = redisCache.Get(ctx, "my_key", &result)
    if err != nil {
        logger.Error("failed to get value from cache", "error", err)
    }
    
    // The log entry from the Get operation inside the Redis driver will
    // automatically contain "request_id=abc-123".
    dcontext.LoggerFromContext(ctx).Info("Got value from cache", "value", result)
}
```
